
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/plot_06_compute_sesame_meg_simulated_frequency_mne.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_plot_06_compute_sesame_meg_simulated_frequency_mne.py>`
        to download the full example code. or to run this example in your browser via Binder

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_06_compute_sesame_meg_simulated_frequency_mne.py:


=========================================================================
Compute SESAME inverse solution on simulated data in the frequency domain
=========================================================================

In the present example we shall devise a synthetic scenario in which
two dipolar sources are active in the cortex. The source time courses
are 10 Hz sinusoids, each modulated by a Gaussian. Simulated MEG recordings
are then corrupted by empty room noise.

We shall use SESAME in the frequency domain [1]_ and see if we can find our two
simulated sources.

References
----------
.. [1] G. Luria et al.,  `Bayesian multi-dipole modelling in the frequency
   domain <https://doi.org/10.1016/j.jneumeth.2018.11.007>`_. J. Neurosci.
   Meth., 312 (2019) 27–36

.. GENERATED FROM PYTHON SOURCE LINES 20-50

.. code-block:: Python

    # Author: Gianvittorio Luria <luria@dima.unige.it>
    #
    # License: BSD (3-clause)

    import os.path as op
    import numpy as np
    from scipy.signal import welch, coherence
    from matplotlib import pyplot as plt

    import mne
    from mne.datasets import sample

    from sesameeg.mne import prepare_sesame


    # We use the MEG and MRI setup from the MNE-Python
    # sample dataset
    data_path = sample.data_path(download=False)
    subjects_dir = op.join(data_path, 'subjects')
    subject = 'sample'

    meg_path = op.join(data_path, 'MEG', 'sample')
    raw_fname = op.join(meg_path, 'sample_audvis_raw.fif')
    fwd_fname = op.join(meg_path, 'sample_audvis-meg-eeg-oct-6-fwd.fif')
    erm_fname = op.join(meg_path, 'ernoise_raw.fif')
    erm_cov_fname = op.join(meg_path, 'ernoise-cov.fif')

    # Seed for the random number generator
    rand = np.random.RandomState(42)








.. GENERATED FROM PYTHON SOURCE LINES 51-53

Load the info, the forward solution and the noise covariance
The forward solution also defines the employed brain discretization.

.. GENERATED FROM PYTHON SOURCE LINES 53-57

.. code-block:: Python

    info = mne.io.read_info(raw_fname)
    fwd = mne.read_forward_solution(fwd_fname)
    noise_cov = mne.read_cov(erm_cov_fname)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

        Read a total of 3 projection items:
            PCA-v1 (1 x 102)  idle
            PCA-v2 (1 x 102)  idle
            PCA-v3 (1 x 102)  idle
    Reading forward solution from /home/pasca/mne_data/MNE-sample-data/MEG/sample/sample_audvis-meg-eeg-oct-6-fwd.fif...
        Reading a source space...
        Computing patch statistics...
        Patch information added...
        Distance information added...
        [done]
        Reading a source space...
        Computing patch statistics...
        Patch information added...
        Distance information added...
        [done]
        2 source spaces read
        Desired named matrix (kind = 3523 (FIFF_MNE_FORWARD_SOLUTION_GRAD)) not available
        Read MEG forward solution (7498 sources, 306 channels, free orientations)
        Desired named matrix (kind = 3523 (FIFF_MNE_FORWARD_SOLUTION_GRAD)) not available
        Read EEG forward solution (7498 sources, 60 channels, free orientations)
        Forward solutions combined: MEG, EEG
        Source spaces transformed to the forward solution coordinate frame
        306 x 306 full covariance (kind = 1) found.
        Read a total of 3 projection items:
            PCA-v1 (1 x 102) active
            PCA-v2 (1 x 102) active
            PCA-v3 (1 x 102) active




.. GENERATED FROM PYTHON SOURCE LINES 58-60

In this example, to save computation time, we shall only simulate gradiometer
data. You can try simulating other types of sensors as well.

.. GENERATED FROM PYTHON SOURCE LINES 60-65

.. code-block:: Python

    picks = mne.pick_types(info, meg='grad', stim=False, exclude='bads')
    mne.pick_info(info, picks, copy=False)
    fwd = mne.pick_channels_forward(fwd, include=info['ch_names'])
    noise_cov = mne.pick_channels_cov(noise_cov, include=info['ch_names'])





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

        203 out of 366 channels remain after picking




.. GENERATED FROM PYTHON SOURCE LINES 66-72

Data simulation
---------------

The following function generates a timeseries that contains an oscillator,
modulated by a Gaussian. The frequency of the oscillator fluctuates a little
over time, but stays close to 10 Hz.

.. GENERATED FROM PYTHON SOURCE LINES 72-124

.. code-block:: Python



    def gen_signal(times, base_freq, rand=None, t_rand=1e-3, std_rand=0.1, g_sigma=None, g_mu_shift=None):
        """Generate an oscillating signal with a Gaussian envelope.

        Parameters
        ----------
        times : array
            Times
        base_freq : float
            Base frequency of the oscillators in Hertz
        t_rand : float
            Variation in the instantaneous frequency of the signal
        std_rand : float
            Std-dev of the random fluctuations added to the signal
        g_sigma : float
            Standard deviation of the enveloping Gaussian
        g_mu_shift: float
            Shift (in seconds) of the mean of the enveloping Gaussian with respect to the
            middle of the time window

        Returns
        -------
        signal : ndarray
            The generated signal.
        """

        n_times = len(times)

        mu_0 = np.floor(times.shape[0] / 2)
        mu_shift = int(g_mu_shift * sfreq)
        mu = int(mu_0 + mu_shift) / sfreq
        gauss = np.exp(-np.power(times - mu, 2.) / (2 * np.power(g_sigma, 2.)))

        if rand is not None:
            # Generate an oscillator with varying frequency and phase lag.
            signal = np.sin(2.0 * np.pi * (base_freq * np.arange(n_times) / sfreq +
                                           np.cumsum(t_rand * rand.randn(n_times))))

            # Add some random fluctuations to the signal.
            signal += std_rand * rand.randn(n_times)
        else:
            signal = np.sin(2.0 * np.pi * (base_freq * np.arange(n_times) / sfreq +
                                           np.cumsum(t_rand * np.random.randn(n_times))))
            signal += std_rand * np.random.randn(n_times)

        # Scale the signal to be in the right order of magnitude (~100 nAm)
        # for MEG data.
        signal *= 100e-9 * gauss

        return signal








.. GENERATED FROM PYTHON SOURCE LINES 125-126

We now simulate two timeseries and plot some basic information about them.

.. GENERATED FROM PYTHON SOURCE LINES 126-160

.. code-block:: Python

    sfreq = info['sfreq']
    n_sample = int(round(5. * sfreq))
    times = np.arange(n_sample) / sfreq
    signal1 = gen_signal(times, 10., g_sigma=.5, g_mu_shift=0)
    signal2 = gen_signal(times, 10., g_sigma=.5, g_mu_shift=.5)
    q = np.vstack((signal1, signal2))

    fig, axes = plt.subplots(2, 2, figsize=(8, 4))

    # Plot the timeseries
    ax = axes[0][0]
    ax.plot(times, 1e9 * signal1, lw=0.5)
    ax.set(xlabel='Time (s)', xlim=times[[0, -1]], ylabel='Amplitude (Am)',
           title='Signal 1')
    ax = axes[0][1]
    ax.plot(times, 1e9 * signal2, lw=0.5, color = 'r')
    ax.set(xlabel='Time (s)', xlim=times[[0, -1]], title='Signal 2')

    # Power spectrum of the first timeseries
    f, p = welch(signal1, fs=sfreq, nperseg=128, nfft=256)
    ax = axes[1][0]
    # Only plot the first 100 frequencies
    ax.plot(f[:100], 20 * np.log10(p[:100]), lw=1.)
    ax.set(xlabel='Frequency (Hz)', xlim=f[[0, 99]],
           ylabel='Power (dB)', title='Power spectrum of signal 1')

    # Compute the coherence between the two timeseries
    f, coh = coherence(signal1, signal2, fs=sfreq, nperseg=100, noverlap=64)
    ax = axes[1][1]
    ax.plot(f[:50], coh[:50], lw=1.)
    ax.set(xlabel='Frequency (Hz)', xlim=f[[0, 49]], ylabel='Coherence',
           title='Coherence between the timeseries')
    fig.tight_layout()




.. image-sg:: /auto_examples/images/sphx_glr_plot_06_compute_sesame_meg_simulated_frequency_mne_001.png
   :alt: Signal 1, Signal 2, Power spectrum of signal 1, Coherence between the timeseries
   :srcset: /auto_examples/images/sphx_glr_plot_06_compute_sesame_meg_simulated_frequency_mne_001.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 161-163

Now we put the signals at two locations on the cortex. To do so, we construct
a :py:class:`mne.SourceEstimate` object to store them in.

.. GENERATED FROM PYTHON SOURCE LINES 163-176

.. code-block:: Python


    # The locations on the cortex where the signal will originate from are
    # indicated as source space grid points indices.
    vertices = [[146374], [33830]]
    vertno = np.hstack([fwd['src'][0]['vertno'], fwd['src'][1]['vertno']])
    true_locs = list()
    for v in vertices:
        true_locs.append(np.where(vertno == v[0])[0][0])

    # Construct SourceEstimates that describe the signals at the cortical level.
    stc_signal = mne.SourceEstimate(q, vertices, tmin=0, tstep=1. / sfreq, subject='sample')









.. GENERATED FROM PYTHON SOURCE LINES 177-180

Now we run the signal through the forward model to obtain simulated sensor
data. We then corrupt the resulting simulated gradiometer recordings
by empty room noise.

.. GENERATED FROM PYTHON SOURCE LINES 180-183

.. code-block:: Python

    evoked = mne.apply_forward(fwd, stc_signal, info)
    mne.simulation.add_noise(evoked, noise_cov, random_state=rand)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

        Average patch normals will be employed in the rotation to the local surface coordinates....
        Converting to surface-based source orientations...
        [done]
    /home/pasca/Tools/python/packages/sesameeg/examples/plot_06_compute_sesame_meg_simulated_frequency_mne.py:180: RuntimeWarning: The maximum current magnitude is 118.3 nAm, which is very large. Are you trying to apply the forward model to noise-normalized (dSPM, sLORETA, or eLORETA) values? The result will only be correct if currents (in units of Am) are used.
      evoked = mne.apply_forward(fwd, stc_signal, info)
    Projecting source estimate to sensor space...
    [done]
    Adding noise to 203/203 channels (203 channels in cov)


.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <script type="text/javascript">
        const toggleVisibility = (className) => {

      const elements = document.querySelectorAll(`.${className}`)

      elements.forEach(element => {
        if (element.classList.contains('repr-section-header')) {
          // Don't collapse the section header row.
           return
        }
        if (element.classList.contains('repr-element-collapsed')) {
          // Force a reflow to ensure the display change takes effect before removing the class
          element.classList.remove('repr-element-collapsed')
          element.offsetHeight // This forces the browser to recalculate layout
          element.classList.remove('repr-element-faded')
        } else {
          // Start transition to hide the element
          element.classList.add('repr-element-faded')
          element.addEventListener('transitionend', handler = (e) => {
            if (e.propertyName === 'opacity' && getComputedStyle(element).opacity === '0.2') {
              element.classList.add('repr-element-collapsed')
              element.removeEventListener('transitionend', handler)
            }
          });
        }
      });

      // Take care of button (adjust caret)
      const button = document.querySelectorAll(`.repr-section-header.${className} > th.repr-section-toggle-col > button`)[0]
      button.classList.toggle('collapsed')

      // Take care of the tooltip of the section header row
      const sectionHeaderRow = document.querySelectorAll(`tr.repr-section-header.${className}`)[0]
      sectionHeaderRow.classList.toggle('collapsed')
      sectionHeaderRow.title = sectionHeaderRow.title === 'Hide section' ? 'Show section' : 'Hide section'
    }
    </script>

    <style type="text/css">
        table.repr.table.table-hover.table-striped.table-sm.table-responsive.small {
      /* Don't make rows wider than they need to be. */
      display: inline;
    }

    table > tbody > tr.repr-element > td {
      /* Apply a tighter layout to the table cells. */
      padding-top: 0.1rem;
      padding-bottom: 0.1rem;
      padding-right: 1rem;
    }

    table > tbody > tr > td.repr-section-toggle-col {
      /* Remove background and border of the first cell in every row
         (this row is only used for the collapse / uncollapse caret)

         TODO: Need to find a good solution for VS Code that works in both
               light and dark mode. */
      border-color: transparent;
      --bs-table-accent-bg: transparent;
    }

    tr.repr-section-header {
      /* Remove stripes from section header rows */
      background-color: transparent;
      border-color: transparent;
      --bs-table-striped-bg: transparent;
      cursor: pointer;
    }

    tr.repr-section-header > th {
      text-align: left !important;
      vertical-align: middle;
    }

    .repr-element, tr.repr-element > td {
      opacity: 1;
      text-align: left !important;
    }

    .repr-element-faded {
      transition: 0.3s ease;
      opacity: 0.2;
    }

    .repr-element-collapsed {
      display: none;
    }

    /* Collapse / uncollapse button and the caret it contains. */
    .repr-section-toggle-col button {
      cursor: pointer;
      width: 1rem;
      background-color: transparent;
      border-color: transparent;
    }

    span.collapse-uncollapse-caret {
      width: 1rem;
      height: 1rem;
      display: block;
      background-repeat: no-repeat;
      background-position: left;
      background-size: contain;
    }

    /* The collapse / uncollapse carets were copied from the free Font Awesome collection and adjusted. */

    /* Default to black carets for light mode */
    .repr-section-toggle-col > button.collapsed > span.collapse-uncollapse-caret {
      background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="black" d="M246.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-128-128c-9.2-9.2-22.9-11.9-34.9-6.9s-19.8 16.6-19.8 29.6l0 256c0 12.9 7.8 24.6 19.8 29.6s25.7 2.2 34.9-6.9l128-128z"/></svg>');
    }

    .repr-section-toggle-col
      > button:not(.collapsed)
      > span.collapse-uncollapse-caret {
      background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="black" d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/></svg>');
    }

    /* Use white carets for dark mode */
    @media (prefers-color-scheme: dark) {
      .repr-section-toggle-col > button.collapsed > span.collapse-uncollapse-caret {
        background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="white" d="M246.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-128-128c-9.2-9.2-22.9-11.9-34.9-6.9s-19.8 16.6-19.8 29.6l0 256c0 12.9 7.8 24.6 19.8 29.6s25.7 2.2 34.9-6.9l128-128z"/></svg>');
      }

      .repr-section-toggle-col
        > button:not(.collapsed)
        > span.collapse-uncollapse-caret {
        background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="white" d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/></svg>');
      }
    }

    .channel-names-btn {
      padding: 0;
      border: none;
      background: none;
      text-decoration: underline;
      text-decoration-style: dashed;
      cursor: pointer;
      color: #0d6efd;
    }

    .channel-names-btn:hover {
      color: #0a58ca;
    }
    </style>



    <table class="repr table table-hover table-striped table-sm table-responsive small">
    







    <tr class="repr-section-header general-624129e7-6ad0-44e1-b050-8b871d957ecd"  title="Hide section" 
        onclick="toggleVisibility('general-624129e7-6ad0-44e1-b050-8b871d957ecd')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>General</strong>
        </th>
    </tr>

    <tr class="repr-element general-624129e7-6ad0-44e1-b050-8b871d957ecd ">
        <td class="repr-section-toggle-col"></td>
        <td>MNE object type</td>
        <td>EvokedArray</td>
    </tr>
    <tr class="repr-element general-624129e7-6ad0-44e1-b050-8b871d957ecd ">
        <td class="repr-section-toggle-col"></td>
        <td>Measurement date</td>
    
        <td>2025-04-15 at 13:55:49 UTC</td>
    
    </tr>
    <tr class="repr-element general-624129e7-6ad0-44e1-b050-8b871d957ecd ">
        <td class="repr-section-toggle-col"></td>
        <td>Participant</td>
    
        <td>Unknown</td>
    
    </tr>
    <tr class="repr-element general-624129e7-6ad0-44e1-b050-8b871d957ecd ">
        <td class="repr-section-toggle-col"></td>
        <td>Experimenter</td>
    
        <td>MEG</td>
    
    </tr>
    







    <tr class="repr-section-header acquisition-064791c1-b853-4804-90f9-8bdd3098d91e" 
        title="Hide section"  onclick="toggleVisibility('acquisition-064791c1-b853-4804-90f9-8bdd3098d91e')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>Acquisition</strong>
        </th>
    </tr>


    <tr class="repr-element acquisition-064791c1-b853-4804-90f9-8bdd3098d91e ">
        <td class="repr-section-toggle-col"></td>
        <td>Aggregation</td>
    
        <td>average of 1 epochs</td>
    
    </tr>


    <tr class="repr-element acquisition-064791c1-b853-4804-90f9-8bdd3098d91e ">
        <td class="repr-section-toggle-col"></td>
        <td>Condition</td>
        <td></td>
    </tr>




    <tr class="repr-element acquisition-064791c1-b853-4804-90f9-8bdd3098d91e ">
        <td class="repr-section-toggle-col"></td>
        <td>Time range</td>
        <td>0.000 – 4.998 s</td>
    </tr>


    <tr class="repr-element acquisition-064791c1-b853-4804-90f9-8bdd3098d91e ">
        <td class="repr-section-toggle-col"></td>
        <td>Baseline</td>
        <td>off</td>
    </tr>


    <tr class="repr-element acquisition-064791c1-b853-4804-90f9-8bdd3098d91e ">
        <td class="repr-section-toggle-col"></td>
        <td>Sampling frequency</td>
        <td>600.61 Hz</td>
    </tr>


    <tr class="repr-element acquisition-064791c1-b853-4804-90f9-8bdd3098d91e ">
        <td class="repr-section-toggle-col"></td>
        <td>Time points</td>
        <td>3,003</td>
    </tr>


    







    <tr class="repr-section-header channels-d5026abf-430d-4363-b1f3-295d7a589212"  title="Hide section" 
        onclick="toggleVisibility('channels-d5026abf-430d-4363-b1f3-295d7a589212')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>Channels</strong>
        </th>
    </tr>


    <tr class="repr-element channels-d5026abf-430d-4363-b1f3-295d7a589212 ">
        <td class="repr-section-toggle-col"></td>
        <td>Gradiometers</td>
        <td>
            <button class="channel-names-btn" onclick="alert('Good Gradiometers:\n\nMEG&nbsp;0113, MEG&nbsp;0112, MEG&nbsp;0122, MEG&nbsp;0123, MEG&nbsp;0132, MEG&nbsp;0133, MEG&nbsp;0143, MEG&nbsp;0142, MEG&nbsp;0213, MEG&nbsp;0212, MEG&nbsp;0222, MEG&nbsp;0223, MEG&nbsp;0232, MEG&nbsp;0233, MEG&nbsp;0243, MEG&nbsp;0242, MEG&nbsp;0313, MEG&nbsp;0312, MEG&nbsp;0322, MEG&nbsp;0323, MEG&nbsp;0333, MEG&nbsp;0332, MEG&nbsp;0343, MEG&nbsp;0342, MEG&nbsp;0413, MEG&nbsp;0412, MEG&nbsp;0422, MEG&nbsp;0423, MEG&nbsp;0432, MEG&nbsp;0433, MEG&nbsp;0443, MEG&nbsp;0442, MEG&nbsp;0513, MEG&nbsp;0512, MEG&nbsp;0523, MEG&nbsp;0522, MEG&nbsp;0532, MEG&nbsp;0533, MEG&nbsp;0542, MEG&nbsp;0543, MEG&nbsp;0613, MEG&nbsp;0612, MEG&nbsp;0622, MEG&nbsp;0623, MEG&nbsp;0633, MEG&nbsp;0632, MEG&nbsp;0642, MEG&nbsp;0643, MEG&nbsp;0713, MEG&nbsp;0712, MEG&nbsp;0723, MEG&nbsp;0722, MEG&nbsp;0733, MEG&nbsp;0732, MEG&nbsp;0743, MEG&nbsp;0742, MEG&nbsp;0813, MEG&nbsp;0812, MEG&nbsp;0822, MEG&nbsp;0823, MEG&nbsp;0913, MEG&nbsp;0912, MEG&nbsp;0923, MEG&nbsp;0922, MEG&nbsp;0932, MEG&nbsp;0933, MEG&nbsp;0942, MEG&nbsp;0943, MEG&nbsp;1013, MEG&nbsp;1012, MEG&nbsp;1023, MEG&nbsp;1022, MEG&nbsp;1032, MEG&nbsp;1033, MEG&nbsp;1043, MEG&nbsp;1042, MEG&nbsp;1112, MEG&nbsp;1113, MEG&nbsp;1123, MEG&nbsp;1122, MEG&nbsp;1133, MEG&nbsp;1132, MEG&nbsp;1142, MEG&nbsp;1143, MEG&nbsp;1213, MEG&nbsp;1212, MEG&nbsp;1223, MEG&nbsp;1222, MEG&nbsp;1232, MEG&nbsp;1233, MEG&nbsp;1243, MEG&nbsp;1242, MEG&nbsp;1312, MEG&nbsp;1313, MEG&nbsp;1323, MEG&nbsp;1322, MEG&nbsp;1333, MEG&nbsp;1332, MEG&nbsp;1342, MEG&nbsp;1343, MEG&nbsp;1412, MEG&nbsp;1413, MEG&nbsp;1423, MEG&nbsp;1422, MEG&nbsp;1433, MEG&nbsp;1432, MEG&nbsp;1442, MEG&nbsp;1443, MEG&nbsp;1512, MEG&nbsp;1513, MEG&nbsp;1522, MEG&nbsp;1523, MEG&nbsp;1533, MEG&nbsp;1532, MEG&nbsp;1543, MEG&nbsp;1542, MEG&nbsp;1613, MEG&nbsp;1612, MEG&nbsp;1622, MEG&nbsp;1623, MEG&nbsp;1632, MEG&nbsp;1633, MEG&nbsp;1643, MEG&nbsp;1642, MEG&nbsp;1713, MEG&nbsp;1712, MEG&nbsp;1722, MEG&nbsp;1723, MEG&nbsp;1732, MEG&nbsp;1733, MEG&nbsp;1743, MEG&nbsp;1742, MEG&nbsp;1813, MEG&nbsp;1812, MEG&nbsp;1822, MEG&nbsp;1823, MEG&nbsp;1832, MEG&nbsp;1833, MEG&nbsp;1843, MEG&nbsp;1842, MEG&nbsp;1912, MEG&nbsp;1913, MEG&nbsp;1923, MEG&nbsp;1922, MEG&nbsp;1932, MEG&nbsp;1933, MEG&nbsp;1943, MEG&nbsp;1942, MEG&nbsp;2013, MEG&nbsp;2012, MEG&nbsp;2023, MEG&nbsp;2022, MEG&nbsp;2032, MEG&nbsp;2033, MEG&nbsp;2042, MEG&nbsp;2043, MEG&nbsp;2113, MEG&nbsp;2112, MEG&nbsp;2122, MEG&nbsp;2123, MEG&nbsp;2133, MEG&nbsp;2132, MEG&nbsp;2143, MEG&nbsp;2142, MEG&nbsp;2212, MEG&nbsp;2213, MEG&nbsp;2223, MEG&nbsp;2222, MEG&nbsp;2233, MEG&nbsp;2232, MEG&nbsp;2242, MEG&nbsp;2243, MEG&nbsp;2312, MEG&nbsp;2313, MEG&nbsp;2323, MEG&nbsp;2322, MEG&nbsp;2332, MEG&nbsp;2333, MEG&nbsp;2343, MEG&nbsp;2342, MEG&nbsp;2412, MEG&nbsp;2413, MEG&nbsp;2423, MEG&nbsp;2422, MEG&nbsp;2433, MEG&nbsp;2432, MEG&nbsp;2442, MEG&nbsp;2512, MEG&nbsp;2513, MEG&nbsp;2522, MEG&nbsp;2523, MEG&nbsp;2533, MEG&nbsp;2532, MEG&nbsp;2543, MEG&nbsp;2542, MEG&nbsp;2612, MEG&nbsp;2613, MEG&nbsp;2623, MEG&nbsp;2622, MEG&nbsp;2633, MEG&nbsp;2632, MEG&nbsp;2642, MEG&nbsp;2643')" title="(Click to open in popup)&#13;&#13;MEG&nbsp;0113, MEG&nbsp;0112, MEG&nbsp;0122, MEG&nbsp;0123, MEG&nbsp;0132, MEG&nbsp;0133, MEG&nbsp;0143, MEG&nbsp;0142, MEG&nbsp;0213, MEG&nbsp;0212, MEG&nbsp;0222, MEG&nbsp;0223, MEG&nbsp;0232, MEG&nbsp;0233, MEG&nbsp;0243, MEG&nbsp;0242, MEG&nbsp;0313, MEG&nbsp;0312, MEG&nbsp;0322, MEG&nbsp;0323, MEG&nbsp;0333, MEG&nbsp;0332, MEG&nbsp;0343, MEG&nbsp;0342, MEG&nbsp;0413, MEG&nbsp;0412, MEG&nbsp;0422, MEG&nbsp;0423, MEG&nbsp;0432, MEG&nbsp;0433, MEG&nbsp;0443, MEG&nbsp;0442, MEG&nbsp;0513, MEG&nbsp;0512, MEG&nbsp;0523, MEG&nbsp;0522, MEG&nbsp;0532, MEG&nbsp;0533, MEG&nbsp;0542, MEG&nbsp;0543, MEG&nbsp;0613, MEG&nbsp;0612, MEG&nbsp;0622, MEG&nbsp;0623, MEG&nbsp;0633, MEG&nbsp;0632, MEG&nbsp;0642, MEG&nbsp;0643, MEG&nbsp;0713, MEG&nbsp;0712, MEG&nbsp;0723, MEG&nbsp;0722, MEG&nbsp;0733, MEG&nbsp;0732, MEG&nbsp;0743, MEG&nbsp;0742, MEG&nbsp;0813, MEG&nbsp;0812, MEG&nbsp;0822, MEG&nbsp;0823, MEG&nbsp;0913, MEG&nbsp;0912, MEG&nbsp;0923, MEG&nbsp;0922, MEG&nbsp;0932, MEG&nbsp;0933, MEG&nbsp;0942, MEG&nbsp;0943, MEG&nbsp;1013, MEG&nbsp;1012, MEG&nbsp;1023, MEG&nbsp;1022, MEG&nbsp;1032, MEG&nbsp;1033, MEG&nbsp;1043, MEG&nbsp;1042, MEG&nbsp;1112, MEG&nbsp;1113, MEG&nbsp;1123, MEG&nbsp;1122, MEG&nbsp;1133, MEG&nbsp;1132, MEG&nbsp;1142, MEG&nbsp;1143, MEG&nbsp;1213, MEG&nbsp;1212, MEG&nbsp;1223, MEG&nbsp;1222, MEG&nbsp;1232, MEG&nbsp;1233, MEG&nbsp;1243, MEG&nbsp;1242, MEG&nbsp;1312, MEG&nbsp;1313, MEG&nbsp;1323, MEG&nbsp;1322, MEG&nbsp;1333, MEG&nbsp;1332, MEG&nbsp;1342, MEG&nbsp;1343, MEG&nbsp;1412, MEG&nbsp;1413, MEG&nbsp;1423, MEG&nbsp;1422, MEG&nbsp;1433, MEG&nbsp;1432, MEG&nbsp;1442, MEG&nbsp;1443, MEG&nbsp;1512, MEG&nbsp;1513, MEG&nbsp;1522, MEG&nbsp;1523, MEG&nbsp;1533, MEG&nbsp;1532, MEG&nbsp;1543, MEG&nbsp;1542, MEG&nbsp;1613, MEG&nbsp;1612, MEG&nbsp;1622, MEG&nbsp;1623, MEG&nbsp;1632, MEG&nbsp;1633, MEG&nbsp;1643, MEG&nbsp;1642, MEG&nbsp;1713, MEG&nbsp;1712, MEG&nbsp;1722, MEG&nbsp;1723, MEG&nbsp;1732, MEG&nbsp;1733, MEG&nbsp;1743, MEG&nbsp;1742, MEG&nbsp;1813, MEG&nbsp;1812, MEG&nbsp;1822, MEG&nbsp;1823, MEG&nbsp;1832, MEG&nbsp;1833, MEG&nbsp;1843, MEG&nbsp;1842, MEG&nbsp;1912, MEG&nbsp;1913, MEG&nbsp;1923, MEG&nbsp;1922, MEG&nbsp;1932, MEG&nbsp;1933, MEG&nbsp;1943, MEG&nbsp;1942, MEG&nbsp;2013, MEG&nbsp;2012, MEG&nbsp;2023, MEG&nbsp;2022, MEG&nbsp;2032, MEG&nbsp;2033, MEG&nbsp;2042, MEG&nbsp;2043, MEG&nbsp;2113, MEG&nbsp;2112, MEG&nbsp;2122, MEG&nbsp;2123, MEG&nbsp;2133, MEG&nbsp;2132, MEG&nbsp;2143, MEG&nbsp;2142, MEG&nbsp;2212, MEG&nbsp;2213, MEG&nbsp;2223, MEG&nbsp;2222, MEG&nbsp;2233, MEG&nbsp;2232, MEG&nbsp;2242, MEG&nbsp;2243, MEG&nbsp;2312, MEG&nbsp;2313, MEG&nbsp;2323, MEG&nbsp;2322, MEG&nbsp;2332, MEG&nbsp;2333, MEG&nbsp;2343, MEG&nbsp;2342, MEG&nbsp;2412, MEG&nbsp;2413, MEG&nbsp;2423, MEG&nbsp;2422, MEG&nbsp;2433, MEG&nbsp;2432, MEG&nbsp;2442, MEG&nbsp;2512, MEG&nbsp;2513, MEG&nbsp;2522, MEG&nbsp;2523, MEG&nbsp;2533, MEG&nbsp;2532, MEG&nbsp;2543, MEG&nbsp;2542, MEG&nbsp;2612, MEG&nbsp;2613, MEG&nbsp;2623, MEG&nbsp;2622, MEG&nbsp;2633, MEG&nbsp;2632, MEG&nbsp;2642, MEG&nbsp;2643">
                203
            </button>

        
        </td>
    </tr>


    <tr class="repr-element channels-d5026abf-430d-4363-b1f3-295d7a589212 ">
        <td class="repr-section-toggle-col"></td>
        <td>Head & sensor digitization</td>
    
        <td>146 points</td>
    
    </tr>
    







    <tr class="repr-section-header filters-42168336-c0fe-44f5-b2c1-630b81046a61"  title="Hide section" 
        onclick="toggleVisibility('filters-42168336-c0fe-44f5-b2c1-630b81046a61')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>Filters</strong>
        </th>
    </tr>

    <tr class="repr-element filters-42168336-c0fe-44f5-b2c1-630b81046a61 ">
        <td class="repr-section-toggle-col"></td>
        <td>Highpass</td>
        <td>0.00 Hz</td>
    </tr>


    <tr class="repr-element filters-42168336-c0fe-44f5-b2c1-630b81046a61 ">
        <td class="repr-section-toggle-col"></td>
        <td>Lowpass</td>
        <td>300.31 Hz</td>
    </tr>


    </table>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 184-185

Visualize the data

.. GENERATED FROM PYTHON SOURCE LINES 185-190

.. code-block:: Python

    evoked.plot()
    _t = evoked.times[(2.0 < evoked.times) & (evoked.times < 3.5)]
    evoked.plot_topomap(times=_t[::50], nrows=3)
    plt.show()




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /auto_examples/images/sphx_glr_plot_06_compute_sesame_meg_simulated_frequency_mne_002.png
         :alt: Gradiometers (203 channels)
         :srcset: /auto_examples/images/sphx_glr_plot_06_compute_sesame_meg_simulated_frequency_mne_002.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /auto_examples/images/sphx_glr_plot_06_compute_sesame_meg_simulated_frequency_mne_003.png
         :alt: 2.001 s, 2.085 s, 2.168 s, 2.251 s, 2.334 s, 2.418 s, 2.501 s, 2.584 s, 2.667 s, 2.751 s, 2.834 s, 2.917 s, 3.000 s, 3.084 s, 3.167 s, 3.250 s, 3.333 s, 3.416 s, 3.500 s, fT/cm
         :srcset: /auto_examples/images/sphx_glr_plot_06_compute_sesame_meg_simulated_frequency_mne_003.png
         :class: sphx-glr-multi-img





.. GENERATED FROM PYTHON SOURCE LINES 191-193

Define the parameters and apply SESAME. We convert the data to the frequency
domain by setting ``fourier=True``.

.. GENERATED FROM PYTHON SOURCE LINES 193-216

.. code-block:: Python


    n_parts = 100
    noise_std = None
    dip_mom_std = None
    freq_min = 9.5
    freq_max = 10.5

    _sesame = prepare_sesame(fwd, evoked, n_parts=n_parts, noise_std=noise_std,
                             top_min=freq_min, top_max=freq_max, dip_mom_std=dip_mom_std,
                             hyper_q=True, fourier=True, subject=subject, subjects_dir=subjects_dir)

    _sesame.apply_sesame()
    print('    Estimated source locations: {0}'.format(_sesame.est_locs[-1]))
    print('    True source locations: {0}'.format(true_locs))

    # Compute goodness of fit
    gof = _sesame.goodness_of_fit()
    print('    Goodness of fit with the recorded data: {0}%'.format(round(gof, 4) * 100))

    # Compute source dispersion
    sd = _sesame.source_dispersion()
    print('    Source Dispersion: {0} mm'.format(round(sd, 2)))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Computing inverse operator with 203 channels.
        203 out of 203 channels remain after picking
    Forward model with free source orientation.
    Computing neighbours matrix [done]
    Computing neighbours probabilities...[done]
    Data have been converted to the frequency domain.
    Analyzing data from 9.6002 Hz to 10.4003 Hz
    Estimating dipole moment std...[done]
     Estimated dipole moment std: 2.1883e-05
    Sampling hyperprior for dipole moment std.
    Estimating noise std...[done]
     Estimated noise std: 2.7059e-09
    Computing inverse solution. This will take a while...
    /home/pasca/Tools/python/packages/sesameeg/sesameeg/particles.py:175: RuntimeWarning: invalid value encountered in log
      self.loglikelihood_unit = - (n_ist * noise_std**2) * np.log(det_sigma)
    Estimated dipole strength variance: 9.916784086727255e-06
        Estimated number of sources: 2
        Estimated source locations:
            * source 1: [0.02482721 0.00881952 0.12250079]
            * source 2: [-0.0283287   0.09554572  0.05893362]
    [done in 96 iterations]
        Estimated source locations: [4367 3554]
        True source locations: [3554, 4367]
        Goodness of fit with the recorded data: 92.73%
        Source Dispersion: 1.33 mm




.. GENERATED FROM PYTHON SOURCE LINES 217-220

Visualize the posterior map of the dipoles' location
:math:`p(r| \textbf{y}, 2)` and the estimated sources on the inflated brain.
If window closes unexpectedly, set force_open=True

.. GENERATED FROM PYTHON SOURCE LINES 220-222

.. code-block:: Python

    _sesame.plot_sources(true_sources=true_locs, force_open=False, plot_kwargs={'distance': 650})




.. image-sg:: /auto_examples/images/sphx_glr_plot_06_compute_sesame_meg_simulated_frequency_mne_004.png
   :alt: plot 06 compute sesame meg simulated frequency mne
   :srcset: /auto_examples/images/sphx_glr_plot_06_compute_sesame_meg_simulated_frequency_mne_004.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Surface stc computed.
    Using pyvistaqt 3d backend.





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 28.064 seconds)


.. _sphx_glr_download_auto_examples_plot_06_compute_sesame_meg_simulated_frequency_mne.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: binder-badge

      .. image:: images/binder_badge_logo.svg
        :target: https://mybinder.org/v2/gh/pybees/sesameeg/master?urlpath=lab/tree/notebooks/auto_examples/plot_06_compute_sesame_meg_simulated_frequency_mne.ipynb
        :alt: Launch binder
        :width: 150 px

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_06_compute_sesame_meg_simulated_frequency_mne.ipynb <plot_06_compute_sesame_meg_simulated_frequency_mne.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_06_compute_sesame_meg_simulated_frequency_mne.py <plot_06_compute_sesame_meg_simulated_frequency_mne.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_06_compute_sesame_meg_simulated_frequency_mne.zip <plot_06_compute_sesame_meg_simulated_frequency_mne.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
